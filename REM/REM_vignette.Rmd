---
title: '**REM analysis vignette**'
author: "Pablo Palencia"
date: "`r Sys.Date()`"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_knit$set(root.dir = 'E:/rprojects/CameraTrappingAnalysis/REM/Data')
```


# 1. Introduction

## 1.1 REM background
The Random Encounter Model (**REM**) is a method for estimating animal density from camera trap data without the need for individual recognition (Rowcliffe et al., 2008 - J. App. Ecol. 45: 1228-1236). Over the last years REM has been used for a wide range of species, with densities values (both in terms of precision and accuracy) equivalent to gold-reference methods (Palencia et al., 2022 - Remote Sens. Ecol. Conserv. 8(5): 670-682).

Briefly, the REM is based on modelling the random encounters between animals and cameras, and accounting for all the variables that affect the encounter rate (i.e. animal speed and camera's detection zone). 

REM equation:
$$
D = \frac{y}{t} \frac{\pi}{v·r·(2+ \alpha) }
$$
in which *y* is the number of encounters (i.e. number of individuals entered detection zone), *t* is total camera survey effort, *v* is the average distance traveled by an individual during a day (day range), and *r* and $\alpha$ are the radius and angle of the camera traps detection zone, respectively. 

## 1.2 Practical exercise
Here, we are going to estimate population density of a fallow deer (*Dama dama*) population sampled with 40 camera traps. (Why fallow deer? Easy, is my favorite species, see **Fig. 1**). Survey design consisted in a systematic design with random origin; concretely cameras were deployed at the intersection of a grid with 2km spacing.

![**Figure 1**: Fallow deer picture](E:/rprojects/CameraTrappingAnalysis/REM/Data/FallowDeerPhoto.jpg)


It is worth noting that all parameters required to apply the REM (i.e., day range, encounter rate, and detection zone) can be estimated directly from camera‐trap data, without relying on auxiliary sources. Although this approach demands additional effort—especially during image processing—it is recommended, as it allows the spatio-temporal variation in day range and the variability in the detection zone to be properly accounted for, including differences related to target species, camera-trap models, settings, and environmental conditions, among others.
Finally, in spite of I'm going to use other packages, should be noted that *remBoot* R package implement REM calculations in R (Caravaggi, 2017 - J. Open Source Softw.- 2(10):176).

# 2. Importing data frames and functions
Three data frames are needed to run the analysis: i) the raw data of day range, detection zone and encounter rate, ii) the operativity matrix (information about camera traps functionality), and iii) camera trap coordinates (just for plots and exploratory analysis). 
Additionally, we will need to import a couple of functions that are not included in an R package (these functions were developed by M. Rowcliffe and Distance Sampling folks from St. Andrews University).

```{r, warning=FALSE, message=FALSE}
# Load data frames
dataREM <- read.table("Data.txt", sep = ";", dec=".", header=TRUE, as.is=TRUE) # parameters data frame
operat <- read.table("Operativity.txt", sep = ";", dec=".", header=TRUE, as.is=TRUE) # operativity matrix (to estimate survey effort)
df_coord <- read.table("Coordinates.txt", sep = ";", dec=".", header=TRUE, as.is=TRUE) # camera trap locations (plots, maps etc.)

# Load functions
source("REM_functions.R") # importing some key functions to run the analysis


# Packages required to run the analyses
library(activity) # to estimate activity pattern and day range (available on CRAN)
library(trappingmotion) # to estimate speed and day range (available on github https://github.com/PabloPalencia/trappingmotion)
library(Distance) # to estimate detection zone (available on CRAN)
library(dplyr) # to work with data frames (available on CRAN)
library(ggplot2) # to plot encounter rates (available on CRAN)
```

# 3. Analysis
As described above, all the parameters needed to apply REM will be estimated from camera trap data (*dataREM* data frame). I have included a specific section for each parameter.

## 3.1 Day range
Day range is a parameter that relies on animal movement. Recent studies have described a procedure to estimate day range from camera trapping data (Palencia et al. 2021 - Methods Ecol. Evol. 12(7):1201-1212; Rowcliffe et al. 2016 - Remote Sens. Ecol. Conserv. 2:84-94). Briefly, day range is estimated as the product of speed (average speed of travel while active) and activity rate (proportion of day that the population spent active).

### 3.1.1 Activity
To estimate activity, we will use the time in which each encounter was recorded.

```{r, fig.width=10, fig.height=6, fig.cap='**Figure 2**: Activity pattern'}

# Convert time of dataREM to a numeric vector of radian time-of-day
time_rad <- gettime(dataREM$time, format = "%H:%M:%S")

# fit activity model
actmod <- fitact(time_rad, sample="model") #sample=model: large sample size (greater than 100-200); sample=dataREM: small sample size (less than 100); o sample=none: no bootstrapping.

# Plot activity patterns
par(mfrow=c(1,1)); plot(actmod)

actmod@act[1] # mean activity level
actmod@act[2] # SE activity level

```

Activity results showed a clear peak around sunrise and two peaks around sunset **Fig. 2**. n activity level of 0.33 indicates that the population was active for 7.92 hours per day (0.33 x 24).  

### 3.1.2 Speed
To estimate speed, we will use the column "speed", which include speed estimations in m/s. Using the package *trappingmotion* we will follow the procedure described by Palencia et al. (2021) - Methods Ecol. Evol. 12(7): 1201-1212. Briefly, we will identify different movement behaviours on the basis of the speeds (**Fig. 3**); and for each behaviour, we will estimate the average speed.

```{r, warning=FALSE, message=FALSE, fig.keep='last', fig.cap='**Figure 3**: Movement behaviours identified'}

# Explore speed distribution. Sometimes it is necessary to remove extreme-low/high values
par(mfrow=c(1,2))
boxplot(dataREM$speed); hist(dataREM$speed)
dataREM.speed <- subset(dataREM, speed < 8)
#dataREM.speed <- subset(dataREM.speed, speed > 0.04)

identbhvs(dataREM.speed$speed) # identify movement states
table(behav_class$behaviour)
meanspeed(behav_class) # average movement speed of each state

```

## 3.1 Day range
Finally, day range is estimated as the sum of the product of the mean speed and the proportion of the activity level associated with each behaviour.
```{r}

dayrange(act=actmod@act[1], act_se=actmod@act[2], speed_data) #day range (daily distance traveled)

```

The day range estimated is 4.19 km/day (SE=0.54), which means that, in average, each fallow deer in the population travels 4.19 km per day.

## 3.2 Detection zone
To estimate the effective detection zone (the area effectively monitored by the cameras), we will follow the procedure described by Rowcliffe et al. (2011) - Methods Ecol. Evol. 2(5):465-476. This approach is based on distance sampling theory (see Buckland et al. 2001 for further details), and therefore requires recording the position (distance and angle relative to the camera) at which fallow deer are first detected. I also recommend consulting Hofmeester et al. (2017 - Remote Sens. Ecol. Conserv. 3(2):81-89) which provides a practical and straightforward method for estimating detection zones when working with camera traps. 

### 3.2.1 Radius
To estimate the effective detection radius, we will use the "radius", column, which contains the distance (in meters) between the animal and the camera at the moment of entry. We will apply a point-transect distance sampling approach. It should be noted that more advanced models can be used by incorporating covariates such as vegetation density, camera model, etc. 

```{r, warning=FALSE, message=FALSE}
# explore and define the truncation distance
hist(dataREM$radius)

w_rad <- 10
# half-normal
hn <- ds(dataREM$radius, transect = "point", key="hn", adjustment = NULL, truncation=w_rad)
hn_cos <- ds(dataREM$radius, transect = "point", key="hn", adjustment = "cos", nadj = 1, truncation=w_rad)
hn_herm <- ds(dataREM$radius, transect = "point", key="hn", adjustment = "herm", nadj = 1, truncation=w_rad)
hn_poly <- ds(dataREM$radius, transect = "point", key="hn", adjustment = "poly", nadj = 1, truncation=w_rad)

# hazard-rate
hr <- ds(dataREM$radius, transect = "point", key="hr", adjustment = NULL, truncation=w_rad)
hr_cos <- ds(dataREM$radius, transect = "point", key="hr", adjustment = "cos", nadj = 1, truncation=w_rad)
hr_herm <- ds(dataREM$radius, transect = "point", key="hr", adjustment = "herm", nadj = 1, truncation=w_rad)
hr_poly <- ds(dataREM$radius, transect = "point", key="hr", adjustment = "poly", nadj = 1, truncation=w_rad)

```

After testing all these models, we will select the best one on the basis of AIC:

```{r}
# model selection
AIC(hn, hn_cos, hn_herm, hn_poly, hr, hr_cos, hr_herm, hr_poly)

# select best model
# (mind the fact that if your data is spiked at zero, you have to be careful with the hazard-rate model (details in Buckland et al. 2001))
best_modRad <- hn 

# Estimating effective detection radius and (SE)
EfecRad <- EDRtransform(best_modRad)

EfecRad$EDR # mean (m)
EfecRad$se.EDR # SE (m)

```

```{r, echo=FALSE, fig.keep='last', fig.cap='**Figure 4**: Detection radius plots'}

# Plots 
par(mfrow=c(1,2))
plot(best_modRad, main="Best model", xlab="Radius (m)",
     showpoints=FALSE, lwd=3, xlim=c(0, 10))
plot(best_modRad, main="Best model", xlab="Radius (m)", pdf=TRUE,
     showpoints=FALSE, lwd=3, xlim=c(0, 10))

```
Effective detection radius (**Fig. 4**) is 5.73 m (SE=0.26), which is consistent with previous studies (e.g. Hofmeester et al. 2017 - Remote Sens. Ecol. Conserv. 3(2):81-89).

### 3.2.2 Angle
To estimate the effective detection angle, we will use the "angle", column, which records the angle (in degrees) at which the individual enters the field of view. We considered angle = 0 to represent the center of the camera’s field of view and assumed that the detection zone is symmetric. The procedure is similar to that used for estimating the detection radius; however, in this case we apply a line-transect distance sampling approach. It should be noted that more complex models can incorporating covariates can be also fitted.

```{r, warning=FALSE, message=FALSE}
dataREM$angle <- abs(dataREM$angle)
hist(dataREM$angle)
w_ang <- 0.41 # truncation angle in radians (=23.5 grados)

# half-normal
hn_Ang <- ds(dataREM$angle, transect = "line", key="hn", adjustment = NULL, truncation=w_ang)
hn_cosAng <- ds(dataREM$angle, transect = "line", key="hn", adjustment = "cos", nadj = 1, truncation=w_ang)
hn_hermAng <- ds(dataREM$angle, transect = "line", key="hn", adjustment = "herm", nadj = 1, truncation=w_ang)
hn_polyAng <- ds(dataREM$angle, transect = "line", key="hn", adjustment = "poly", nadj = 1, truncation=w_ang)

# hazard-rate
hr_Ang <- ds(dataREM$angle, transect = "line", key="hr", adjustment = NULL, truncation=w_ang)
hr_cosAng <- ds(dataREM$angle, transect = "line", key="hr", adjustment = "cos", nadj = 1, truncation=w_ang)
hr_hermAng <- ds(dataREM$angle, transect = "line", key="hr", adjustment = "herm", nadj = 1, truncation=w_ang)
hr_polyAng <- ds(dataREM$angle, transect = "line", key="hr", adjustment = "poly", nadj = 1, truncation=w_ang)

# uniform
uni_cosAng <- ds(dataREM$angle, transect = "line", key="uni", adjustment = "cos", nadj = 1, truncation=w_ang)
uni_hermAng <- ds(dataREM$angle, transect = "line", key="uni", adjustment = "herm", nadj = 1, truncation=w_ang)
uni_polyAng <- ds(dataREM$angle, transect = "line", key="uni", adjustment = "poly", nadj = 1, truncation=w_ang)

```
After testing all these models, we will select the best one on the basis of AIC:

```{r}
# model comparison
AIC(hn_Ang, hn_cosAng, hn_hermAng, hn_polyAng, hr_Ang, hr_cosAng, hr_hermAng, hr_polyAng, uni_cosAng, uni_hermAng, uni_polyAng)

# select best model
best_modAng <- uni_cosAng  

# Estimating effective detection radius and (SE)
summary_ang<- summary(best_modAng$ddf)

EfecAng_mean <- summary_ang$average.p*w_ang # mean (radians)
EfecAng_SE <-  summary_ang$average.p.se*w_ang # SE (radians)

```
Effective detection radius (**Fig. 5**) is 0.41 rad (SE=0.04) (i.e. 23.49 degrees).

```{r, echo=FALSE, fig.keep='last', fig.cap='**Figure 5**: Detection angle plot'}

# Plots 
par(mfrow=c(1,1))
plot(best_modAng, main="Best model", xlab="Angle (rad)",
     showpoints=FALSE, lwd=3, xlim=c(0, w_ang))

```
Finally, and just to clarify, the interpretation of effective detection radius (or angle) is the threshold value at which the expected number of missed within is equal to the expected number detected beyond (Buckland et al. 2001). 

## 3.3 Encounter rate
Finally, we will estimate the encounter rate. In our data frame (*dataREM*), a new row was added each time an individual entered the detection zone (i.e., each encounter), with individuals treated as the unit of observation. Based on this, we will aggregate the number of rows for each (dataREM$camera). In addition, the sampling effort for each camera trap will be estimated using the information provided in (*operat*), which records the operational period of each camera. 


```{r, warning=FALSE, message=FALSE, echo=FALSE, fig.keep='last', fig.cap='**Figure 6**: Encounter rate map. The areas of the blue circles are proportional to the encounter rates'}

dataREM.dens <- as.data.frame(dataREM)

# estimate survey effort
tm <- sum(operat$days) # Survey effort (camera days)

dataREM.dens$angle <- abs(dataREM.dens$angle)
dataREM.dens <- subset(dataREM.dens, radius <= w_rad & angle <= w_ang) # Based on truncation distance to estimate effective radius and angle
seq <- length(dataREM.dens[, 1]) # Number of encounters

seq_point<-(table(dataREM.dens$camera))
operat <- merge(operat, seq_point, by.x= "camera", by.y = "Var1", all.x = TRUE); operat[is.na(operat)] <- 0
operat$tr <- operat$Freq/operat$days

enc_rate<-operat[,c("Freq","days")] # Selecting columns

# Plot encounter rate
df_coord$ER <- enc_rate$Freq # add encounter rate to coordinates dataREM frame

ggplot(data = df_coord) +
  aes(x = x, y = y, size = ER, colour = ER == 0) + 
  geom_point(alpha = 1, shape = 16) +
  scale_size(breaks = c(0, 1, 5, 10, 20, 50), range = c(1, 40)) +
  scale_colour_manual(values = c("FALSE" = "blue", "TRUE" = "red")) +
  ylab("Latitude (m)") +
  xlab("Longitude (m)") +
  theme(
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.background = element_blank(),
    panel.border = element_rect(colour = "black", fill = NA, size = 1),
    legend.position = "none",
    axis.title.y = element_text(color = "black", size = 20, face = "bold"),
    axis.title.x = element_text(color = "black", size = 20, face = "bold"),
    axis.text.y = element_text(size = rel(2)),
    axis.text.x = element_text(size = rel(2))
  )


```
In summary, we need a data frame (here *enc_rate*) in which one column represent the *y* parameter (here *Freq*) and another column represent *t* parameter (here *days*) of the REM equation.

```{r}
head(enc_rate) # data frame to estimate encounter rate
```

As **Fig. 6** shows, encounter rates are highly aggregated. In 20 of the 40 cameras, no animals were detected, whereas in two cameras more than 30 sequences were recorded at each site. This pattern is common in REM studies due to the random placement of cameras and the naturally uneven distribution of animals. Crucially, most of the variance in density estimates arises from the variation in encounter rates among camera traps. 

# 4. Density results
After estimate all the parameters necessary to apply REM, we can estimate population density.
```{r}
# We include in a list average values of day range and detection zone
param <- list(DR = DR,
              r = EfecRad$EDR / 1000,
              theta = EfecAng_mean*2)

# We include in a list standard error values of day range and detection zone
paramse <- list(DR = DR_se,
                r = EfecRad$se.EDR / 1000,
                theta = EfecAng_SE*2)

# Density estimation
density<-bootTRD(enc_rate$Freq, enc_rate$days, param, paramse); density

# CV
density[,2]/density[,1]

# Log-normal CIs
df_lnorm_confint <- lnorm_confint(density[,1], density[,2])

```

Finally, the density of this fallow deer population is 3.35 ind/$km^{2}$ (SE=1.09). Average and SE errors of REM parameters are included in the data frame *results*:
```{r, echo=FALSE}
# Saving results
results <- data.frame(seq, tm, DR, DR_se, EfecRad$EDR, EfecRad$se.EDR, EfecAng_mean*2, EfecAng_SE*2, density[,1], density[,2], df_lnorm_confint[1,1], df_lnorm_confint[1,2])
dimnames(results) <- list("Value", c("seq","tm", "dr(km/day)","dr_se(km/day)", "r(m)", "r_se(m)", "ang(rad)", "ang_se(rad)", "d(ind/km2)", "d_se(ind/km2)", "lcl_lognorm95%", "ucl_lognorm95%")); View(results)

```

```{r}
# Saving results
head(results)

```
