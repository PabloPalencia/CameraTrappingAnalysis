---
title: "REM vignette"
author: "Pablo Palencia"
date: "8 de abril de 2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_knit$set(root.dir = 'D:/rprojects/CameraTrappingAnalysis/REM/Data')
```


# 1. Introduction

## 1.1 REM background
The Random Encounter Model (**REM**) is a method for estimating animal density from camera trap data without the need for individual recognition (Rowcliffe et al., 2008 - J. App. Ecol. 45: 1228-1236). Over the last years it has been used for a wide range of unmarked species (Cusack et al., 2015 - J. Wild. Manag. 79(6): 1014-1021; ENETWILD-consortium et al., 2019 - EFSA Supporting Publications - 16(9); Pfeffer et al., 2018 - Remote Sens. Ecol. Conserv. 2:84-94; Zero et al., 2013 - Oryx 47(3): 410-419).

## 1.2 Practical exercise
Here, I'm going to estimate population density of fallow deer (*Dama dama*) population samped with 30 camera traps. (Why fallow deer? Easy, is my favourite species, see **Fig. 1**).

![**Figure 1**: Fallow deer picture](D:/rprojects/CameraTrappingAnalysis/REM/Data/FallowDeerPhoto.jpg)


Should be noted that all the necessary parameters to apply REM (i.e. day range, encounter rate and detection zone) will be derived from camera trap data. Without the need of auxiliary data. This required additional effort, especialy during image processing, but it is recommended taking into account the spatio-temporal variations in day range, and the variability in detection zone as function of target species, camera trap brand, settings and enviromental variables between others. Please, note that *remBoot* R package implemet REM calculations in R (Caravaggi, 2017 - J. Open Source Softw.- 2(10):176).

# 2. Importing dataframes and functions
Three dataframes are needed to run the analysis: i) the raw data of day range, detection zone and encounter rate, ii) the operativity matrix (information about camera traps functionality), and iii) camera trap coordinates (just for plots and exploratory analysis). 
Adittionally, we will need to import a couple of functions that are not included in an R package (these functions were devoloped by M. Rowcliffe and Distance Sampling folks from St. Andrews University).

```{r, warning=FALSE, message=FALSE}
# Load dataframes
data <- read.table("Data.txt", sep = ";", dec=".", header=TRUE, as.is=TRUE) # parameters dataframe
operat <- read.table("Operativity.txt", sep = ";", dec=".", header=TRUE, as.is=TRUE) # operatity matrix (to estimate survey effort)
df_coord <- read.table("Coordinates.txt", sep = ";", dec=".", header=TRUE, as.is=TRUE) # camera trap locations (plots, maps etc.)

# Load functions
source("REM_functions.R") # importing some key functions to run the analysis


# Packages required to run the analyses
library(activity) # to estimate activity pattern and day range (available on CRAN)
library(trappingmotion) # to estimate speed and day range (available on github https://github.com/PabloPalencia/trappingmotion)
library(Distance) # to estimate detection zone (available on CRAN)
library(dplyr) # to work with dataframes (available on CRAN)

```

# 3. Analysis
As described above, all the parameters needed to apply REM will be derived from camera trap data (*data* dataframe). I have included a specific section for each parameter.

## 3.1 Day range
Day range (average daily distance travelled by and individual) is a parameter that relies on movement and behaviour. Recent studies have described a porcedure to estimate day range from camera trapping data (Palencia et al. 2021 - Methods Ecol. Evol. doi: 10.1111/2041-210X.13609; Rowcliffe et al. 2016 - Remote Sens. Ecol. Conserv. 2:84-94). Briefly, day range is estimated as the product of speed (average speed of travel while active) and activity rate (proportion of day that the population spent active).

### 3.1.1 Activity
To estimate activity, we will use the columns "G_size" and "H_first". "G_size" includes the number of animals observed per group, and "H_first" includes the time of the first photo of each group.(Adittionally, to avoid the bias caused by shorter detection distances at night (see Rowcliffe et al. 2014 Methods Ecol. Evol, 5(11): 1170-1179), we just considered for activity estimate sequences closer than 5m to the cameras -i.e. "Interval.min == 1 | 2").

```{r, fig.width=10, fig.height=6, fig.cap='**Figure 2**: Activity pattern'}
data.acti <- as.data.frame(data)

# Estimating radian time of day
data.acti$T_sec2 <- as.numeric(strptime(data.acti$H_first, format="%H:%M:%S") - as.POSIXct(format(Sys.Date())), units="secs")
data.acti$T_0_1 <- data.acti$T_sec2/86400; data.acti <- subset(data.acti, G_size!="NA") # remove NAs

# Replicating each sequence based on the group size
activity.repli <- data.acti[rep(row.names(data.acti), data.acti$G_size), 1:16] 

# Discariding observations further than 5 meters (see Rowcliffe et al. 2014 Methods Ecol. Evol, 5(11): 1170-1179)
activity.repli <- subset(activity.repli, Interval.min =="1"  | Interval.min =="2")

# Estimating activity rate
activityRES <- 2*pi*activity.repli$T_0_1
mod1 <- fitact(activityRES, sample="data") 

# Plot activity patterns
par(mfrow=c(1,1)); plot(mod1)

mod1@act[1] # mean activity level
mod1@act[2] # SE activity level

```

Activity results evidenced two peaks of activity during sunrise and sunset **Fig. 2**, which is expected for ungulates. Activity level of 0.23 can be interpreted as the population spent acitive (0.23 x 24) 5.5 hours per day.  

### 3.1.2 Speed
To estimate speed, we will use the column "Speed.m.s", which include speed estimations in m/s of those animals that did not react to the camera traps. Using the package *trappingmotion* we will follow the procedure described by Palencia et al. (2021). Briefly, we will identify different movement behaviours on the basis of the speeds (**Fig. 3**); and for each behaviour, we will estimate the average speed. Those sequences in which animals react to the camera trap cannot be considered for speed estimation (Rowcliffe et al. 2016 - Remote Sens. Ecol. Conserv. 2:84-94).

```{r, warning=FALSE, message=FALSE, fig.keep='last', fig.cap='**Figure 3**: Movement behaviours identified'}

data.speed <- subset(data, Behaviour != "Curiosity") # discard animals that react to the camera
data.speed <- subset(data.speed, Speed.m.s!="NA"); data.speed$Speed.m.s <- as.numeric(as.character(data.speed$Speed.m.s)) # Remove NAs

identbhvs(data.speed$Speed.m.s) # identify movement state
meanspeed(behav_class) # average movement speed of each state

```

## 3.1 Day range
Finally, day range is estimated as the sum of the product of the mean speed and the proportion of the activity level associated with each behaviour.
```{r}

dayrange(act=mod1@act[1], act_se=mod1@act[2], speed_data) #day range (daily distance travelled)

```

The day range estimated is 1.37 km per day (SE=0.1), which means that, in average, each fallow deer in the population travels 1.37km per day.

## 3.2 Detection zone
To estimate effective detecion zone (are effectively monitored by cameras), we will follow the procedure described by Rowcliffe et al. (2011) - Methods Ecol. Evol. 2(5):465-476. These procedure borrows from distance sampling theory (see Buckland et al. 2001 for further details), and it is needed to record the position (distance and angle relative to the camera) where the fallow deers are first detected.I also recommend to have a look to Hofmeester et al. 2017 - Remote Sens. Ecol. Conserv. 3(2):81-89 for practical and simple method to estimate detection zone when working with camera traps. 

### 3.2.1 Radius
To estimate effective detection radius we will use the column "Dist_det", which include the distance -in meters- between animals and cameras in the first photo of each sequence. When more than one animal appeared in the first photo, we recorded the distance to the closer one. We will apply a point-transect distance sampling. Should be noted that advanced models can be considered by including covariates as sampling point or vegetation cover, betweeen others. 

```{r}
data_dz_r<-subset(data, Dist_det >= 0 ) # selecting data to estimate effective detection radius

w_rad <- 10 # truncation distance (in meters)

# half-normal
hn_cos0 <- ds(data_dz_r$Dist_det, transect = "point", key="hn", adjustment = "cos", order = 0, truncation=w_rad) 

#hazard-rate
hr_cos0 <- ds(data_dz_r$Dist_det, transect = "point", key="hr", adjustment = "cos", order = 0, truncation=w_rad) 

```
Here I included just two models as example, but should be tested as minimun all the combinations between 'half-normal' and 'hazard-rate' functions, 'cos', 'herm' and 'poly' adjustments, and orders 0 and 2.

```{r, echo=FALSE, warning=FALSE, message=FALSE}
# half-normal
hn_cos2 <- ds(data_dz_r$Dist_det, transect = "point", key="hn", adjustment = "cos", order = 2, truncation=w_rad)
hn_herm0 <- ds(data_dz_r$Dist_det, transect = "point", key="hn", adjustment = "herm", order = 0, truncation=w_rad)
hn_herm2 <- ds(data_dz_r$Dist_det, transect = "point", key="hn", adjustment = "herm", order = 2, truncation=w_rad)
hn_poly0 <- ds(data_dz_r$Dist_det, transect = "point", key="hn", adjustment = "poly", order = 0, truncation=w_rad)
hn_poly2 <- ds(data_dz_r$Dist_det, transect = "point", key="hn", adjustment = "poly", order = 2, truncation=w_rad)

#hazard-rate
hr_herm0 <- ds(data_dz_r$Dist_det, transect = "point", key="hr", adjustment = "herm", order = 0, truncation=w_rad)
hr_herm2 <- ds(data_dz_r$Dist_det, transect = "point", key="hr", adjustment = "herm", order = 2, truncation=w_rad)
hr_poly0 <- ds(data_dz_r$Dist_det, transect = "point", key="hr", adjustment = "poly", order = 0, truncation=w_rad)
hr_poly2 <- ds(data_dz_r$Dist_det, transect = "point", key="hr", adjustment = "poly", order = 2, truncation=w_rad)
```
After testing all these models, we will select the best one on the basis of AIC:

```{r}
#model comparison
AIC(hn_cos0, hn_cos2, hn_herm0, hn_herm2, hn_poly0, hn_poly2, hr_cos0, hr_herm0, hr_herm2, hr_poly0, hr_poly2)

# select best model
# (mind the fact that if your data is spiked at zero, you have to be carefoul with the hazard-rate model (details in Buckland et al. 2001))
best_modRad <- hr_cos0 # AIC 413.44

# Estimating effective detection radius and (SE)
EfecRad <- EDRtransform(best_modRad)

EfecRad$EDR # mean (m)
EfecRad$se.EDR # SE (m)

```

```{r, echo=FALSE, fig.keep='last', fig.cap='**Figure 4**: Detection radius plots'}

# Plots 
par(mfrow=c(1,2))
plot(best_modRad, main="Best model", xlab="Radius (m)",
     showpoints=FALSE, lwd=3, xlim=c(0, 10))
plot(best_modRad, main="Best model", xlab="Radius (m)", pdf=TRUE,
     showpoints=FALSE, lwd=3, xlim=c(0, 10))

```
Effective detection radius (**Fig. 4**) is 4.83m (SE=0.88) which is consistent with previous studies (e.g. Hofmeester et al. 2017 - Remote Sens. Ecol. Conserv. 3(2):81-89).

### 3.2.2 Angle
To estimate effective detection angle we will use the column "Angle_det", which include the angle -in degrees- in the first photo of each sequence. When more than one animal appeared in the first photo, we recorded the angle to the closer one.
We considered angle=0 in the centrer of the field of view, and we assumed that detection zone is symmetric
We will proceed in a similar way than when estimating radius. Now, we apply a line-transect distance sampling. Should be noted that advanced models can be considered by including covariates as sampling point or vegetation cover, betweeen others.

```{r}
data_dz_ang<-subset(data, Ang_det != "NA" ) # selecting data to estimate effective detection angle

data_dz_ang$Ang_rad <- abs(data_dz_ang$Ang_det*0.0174533) # transform degrees to radians
FOV <- 42 # field of view of the cameras (degrees)
w_ang <- FOV/2*0.0174533 # truncation angle (in radians)

# half-normal
hn_cos0Ang <- ds(data_dz_ang$Ang_rad, transect = "line", key="hn", adjustment = "cos", order = 0, truncation=w_ang) 

#hazard-rate
hr_cos0Ang <- ds(data_dz_ang$Ang_rad, transect = "line", key="hr", adjustment = "cos", order = 0, truncation=w_ang) 

```
Again, all the combinations between 'half-normal' and 'hazard-rate' functions, 'cos', 'herm' and 'poly' adjustments, and orders 0 and 2 should be tested.

```{r, echo=FALSE, warning=FALSE, message=FALSE}
# half-normal
hn_cos2Ang <- ds(data_dz_ang$Ang_rad, transect = "line", key="hn", adjustment = "cos", order = 2, truncation=w_ang)
hn_herm0Ang <- ds(data_dz_ang$Ang_rad, transect = "line", key="hn", adjustment = "herm", order = 0, truncation=w_ang)
hn_herm2Ang <- ds(data_dz_ang$Ang_rad, transect = "line", key="hn", adjustment = "herm", order = 2, truncation=w_ang)
hn_poly0Ang <- ds(data_dz_ang$Ang_rad, transect = "line", key="hn", adjustment = "poly", order = 0, truncation=w_ang)
hn_poly2Ang <- ds(data_dz_ang$Ang_rad, transect = "line", key="hn", adjustment = "poly", order = 2, truncation=w_ang)

#hazard-rate
hr_cos2Ang <- ds(data_dz_ang$Ang_rad, transect = "line", key="hr", adjustment = "cos", order = 2, truncation=w_ang)
hr_herm0Ang <- ds(data_dz_ang$Ang_rad, transect = "line", key="hr", adjustment = "herm", order = 0, truncation=w_ang)
hr_herm2Ang <- ds(data_dz_ang$Ang_rad, transect = "line", key="hr", adjustment = "herm", order = 2, truncation=w_ang)
hr_poly0Ang <- ds(data_dz_ang$Ang_rad, transect = "line", key="hr", adjustment = "poly", order = 0, truncation=w_ang)
hr_poly2Ang <- ds(data_dz_ang$Ang_rad, transect = "line", key="hr", adjustment = "poly", order = 2, truncation=w_ang)
```
After testing all these models, we will select the best one on the basis of AIC:

```{r}
#model comparison
AIC(hn_cos0Ang, hn_cos2Ang, hn_herm0Ang, hn_herm2Ang, hn_poly0Ang, hn_poly2Ang, hr_cos0Ang, hr_cos2Ang, hr_herm0Ang, hr_herm2Ang, hr_poly0Ang, hr_poly2Ang)


# select best model
# (mind the fact that if your data is spiked at zero, you have to be carefoul with the hazard-rate model (details in Buckland et al. 2001))
best_modAng <- hr_cos0Ang  # AIC 413.44

# Estimating effective detection radius and (SE)
summary_ang<- summary(best_modAng$ddf)

EfecAng_mean <- summary_ang$average.p*w_ang # mean (radians)
EfecAng_SE <-  summary_ang$average.p.se*w_ang # SE (radians)

```

```{r, echo=FALSE, fig.keep='last', fig.cap='**Figure 5**: Detection angle plot'}

# Plots 
par(mfrow=c(1,1))
plot(best_modAng, main="Best model", xlab="Angle (rad)",
     showpoints=FALSE, lwd=3, xlim=c(0, w_ang))

```
Finally, and just to clarify, the interpretation of effective detection radius or angle is the threshold value at which the expected number of missed within is equal to the expected number detected beyond. 

## 3.3 Encounter rate
